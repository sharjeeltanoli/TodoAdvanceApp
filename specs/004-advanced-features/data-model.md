# Data Model: Enhanced Task Management (004-advanced-features)

**Date**: 2026-02-16
**Feature**: [spec.md](./spec.md)

## Entity: Task (extended)

Extends the existing `task` table with new columns. Existing rows receive default values.

### Fields

| Field | Type | Nullable | Default | Constraint | Notes |
| ----- | ---- | -------- | ------- | ---------- | ----- |
| id | UUID | NO | uuid_generate_v4() | PK | Existing |
| user_id | TEXT | NO | — | FK → user.id CASCADE | Existing |
| title | VARCHAR(255) | NO | — | min_length=1 | Existing |
| description | TEXT | YES | NULL | max_length=2000 | Existing |
| completed | BOOLEAN | NO | false | — | Existing |
| created_at | TIMESTAMPTZ | NO | now() | — | Existing |
| updated_at | TIMESTAMPTZ | NO | now() | — | Existing |
| **priority** | TEXT | NO | 'medium' | CHECK (IN 'high','medium','low') | **NEW** |
| **tags** | JSONB | NO | '[]'::jsonb | Array of lowercase strings, max 10 | **NEW** |
| **due_date** | TIMESTAMPTZ | YES | NULL | — | **NEW** |
| **recurrence_pattern** | JSONB | YES | NULL | `{frequency, interval, next_due}` | **NEW** |
| **reminder_minutes** | INTEGER | YES | NULL | CHECK (IN 15, 60, 1440) or NULL | **NEW** |
| **snoozed_until** | TIMESTAMPTZ | YES | NULL | — | **NEW** — set by snooze endpoint; reminders suppressed until this time |
| **reminder_notified_at** | TIMESTAMPTZ | YES | NULL | — | **NEW** — tracks when notification was last shown; prevents duplicates |
| **parent_task_id** | UUID | YES | NULL | FK → task.id SET NULL | **NEW** — links generated instance to recurring parent |

### Indexes

| Name | Columns | Type | Condition |
| ---- | ------- | ---- | --------- |
| ix_task_user_id | (user_id) | BTREE | — | Existing |
| ix_task_user_created | (user_id, created_at DESC) | BTREE | — | Existing |
| **ix_task_user_priority** | (user_id, priority) | BTREE | — | **NEW** |
| **ix_task_user_due** | (user_id, due_date) | BTREE | WHERE due_date IS NOT NULL | **NEW** |
| **ix_task_tags_gin** | (tags) | GIN | — | **NEW** |

### Validation Rules

- `priority`: Must be one of `high`, `medium`, `low`. Defaults to `medium`.
- `tags`: Array of strings. Each tag: 1-50 chars, lowercase, alphanumeric + hyphens. Max 10 tags per task.
- `due_date`: Optional. If set, must be a valid timestamp. No restriction on past dates (allows overdue tracking).
- `recurrence_pattern`: Optional JSON object with structure:
  ```json
  {
    "frequency": "daily" | "weekly" | "monthly",
    "interval": 1,
    "next_due": "2026-02-17T09:00:00Z"
  }
  ```
- `reminder_minutes`: Optional. If set, must be one of: 15 (15 min before), 60 (1 hour before), 1440 (1 day before).
- `snoozed_until`: Optional. Set by snooze endpoint to `NOW() + 15 min`. Reminders are suppressed until this time passes.
- `reminder_notified_at`: Optional. Set by the frontend after showing a notification. Prevents duplicate notifications. Cleared when `snoozed_until` is set (so the reminder re-fires after the snooze period).
- `parent_task_id`: Optional. Set when a task is auto-generated by the recurrence scheduler. Points to the recurring parent task.

### State Transitions

```text
Task lifecycle:
  [Created] → pending (completed=false)
  [Completed] → completed (completed=true)
  [Toggled back] → pending (completed=false)

Recurring task lifecycle:
  [Parent created with recurrence_pattern] → scheduler watches
  [Scheduler fires] → new child task created (parent_task_id set)
  [Recurrence disabled] → recurrence_pattern set to NULL, no more children
  [Parent deleted] → parent_task_id on children set to NULL (ON DELETE SET NULL)
```

## Entity Relationships

```text
user (1) ──── (N) task
task (1) ──── (N) task [parent_task_id → id, self-referential for recurring instances]
```

## Migration Strategy

**Migration file**: `backend/alembic/versions/004_add_advanced_fields.py`
**Revision**: `004` (depends on latest existing revision)

Steps:
1. `ALTER TABLE task ADD COLUMN priority TEXT NOT NULL DEFAULT 'medium'` + CHECK constraint
2. `ALTER TABLE task ADD COLUMN tags JSONB NOT NULL DEFAULT '[]'::jsonb`
3. `ALTER TABLE task ADD COLUMN due_date TIMESTAMPTZ NULL`
4. `ALTER TABLE task ADD COLUMN recurrence_pattern JSONB NULL`
5. `ALTER TABLE task ADD COLUMN reminder_minutes INTEGER NULL`
6. `ALTER TABLE task ADD COLUMN snoozed_until TIMESTAMPTZ NULL`
7. `ALTER TABLE task ADD COLUMN reminder_notified_at TIMESTAMPTZ NULL`
8. `ALTER TABLE task ADD COLUMN parent_task_id UUID NULL REFERENCES task(id) ON DELETE SET NULL`
9. Create new indexes
10. Downgrade: Drop columns and indexes in reverse order

**Backward compatibility**: All new columns have defaults or are nullable. Existing tasks automatically get `priority='medium'` and `tags='[]'`. No data loss.
