# Prometheus Setup Example for hackathon-todo
#
# This example shows the complete Prometheus configuration for monitoring
# the hackathon-todo application on DigitalOcean DOKS.
#
# Prerequisites:
#   - kube-prometheus-stack installed
#   - Application services exposing /metrics endpoints

# =============================================================
# STEP 1: Install kube-prometheus-stack
# =============================================================

# helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
# helm repo update
#
# helm install monitoring prometheus-community/kube-prometheus-stack \
#   --namespace monitoring --create-namespace \
#   --set grafana.adminPassword="change-me-in-production" \
#   --set prometheus.prometheusSpec.retention=7d \
#   --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=10Gi \
#   --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.storageClassName=do-block-storage \
#   --set alertmanager.alertmanagerSpec.retention=120h \
#   --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false \
#   --set prometheus.prometheusSpec.ruleSelectorNilUsesHelmValues=false

# =============================================================
# STEP 2: ServiceMonitors for Application Services
# =============================================================

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: hackathon-todo-backend
  namespace: production
  labels:
    app: hackathon-todo
    component: backend
    release: monitoring
spec:
  selector:
    matchLabels:
      app: hackathon-todo
      component: backend
  endpoints:
    - port: http
      path: /metrics
      interval: 15s
      scrapeTimeout: 10s
  namespaceSelector:
    matchNames:
      - production
      - staging

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: hackathon-todo-mcp-server
  namespace: production
  labels:
    app: hackathon-todo
    component: mcp-server
    release: monitoring
spec:
  selector:
    matchLabels:
      app: hackathon-todo
      component: mcp-server
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
  namespaceSelector:
    matchNames:
      - production
      - staging

# =============================================================
# STEP 3: Recording Rules (pre-compute expensive queries)
# =============================================================

---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: hackathon-todo-recording-rules
  namespace: production
  labels:
    release: monitoring
spec:
  groups:
    - name: hackathon-todo.recording
      interval: 30s
      rules:
        # Overall request rate
        - record: hackathon:request_rate:5m
          expr: sum(rate(http_request_duration_seconds_count[5m]))

        # Error rate percentage
        - record: hackathon:error_rate_percent:5m
          expr: |
            100 * sum(rate(http_request_duration_seconds_count{status=~"5.."}[5m]))
            / sum(rate(http_request_duration_seconds_count[5m]))

        # p95 latency
        - record: hackathon:latency_p95:5m
          expr: |
            histogram_quantile(0.95,
              sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
            )

        # Tasks created per hour
        - record: hackathon:tasks_created:1h
          expr: sum(increase(tasks_created_total[1h]))

# =============================================================
# STEP 4: Alert Rules
# =============================================================

---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: hackathon-todo-alerts
  namespace: production
  labels:
    release: monitoring
spec:
  groups:
    - name: hackathon-todo.availability
      rules:
        - alert: BackendDown
          expr: up{job="hackathon-todo-backend"} == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "Backend service is down"
            description: "No backend instances are responding to health checks."

        - alert: PodCrashLooping
          expr: increase(kube_pod_container_status_restarts_total{namespace=~"production|staging"}[15m]) > 3
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Pod {{ $labels.pod }} is crash-looping"

    - name: hackathon-todo.performance
      rules:
        - alert: SlowAPI
          expr: hackathon:latency_p95:5m > 2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "API p95 latency above 2s (current: {{ $value | humanizeDuration }})"

        - alert: HighErrorRate
          expr: hackathon:error_rate_percent:5m > 5
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "5xx error rate above 5% (current: {{ $value | humanize }}%)"

# =============================================================
# STEP 5: Verify Setup
# =============================================================

# Check ServiceMonitors are picked up:
#   kubectl get servicemonitors -n production
#
# Check Prometheus targets:
#   kubectl port-forward svc/monitoring-kube-prometheus-prometheus 9090:9090 -n monitoring
#   Open http://localhost:9090/targets
#
# Check alert rules:
#   Open http://localhost:9090/rules
#
# Access Grafana:
#   kubectl port-forward svc/monitoring-grafana 3001:80 -n monitoring
#   Open http://localhost:3001 (admin / change-me-in-production)
#
# Test a PromQL query:
#   http://localhost:9090/graph?g0.expr=up&g0.tab=1
