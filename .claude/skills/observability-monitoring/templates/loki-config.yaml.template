# Loki Configuration for Log Aggregation
# Used with: helm install loki grafana/loki-stack -f this-file.yaml
#
# Variables:
#   {{RETENTION_PERIOD}}  - Log retention (e.g., 168h = 7 days, 720h = 30 days)
#   {{STORAGE_SIZE}}      - PVC size for log storage (e.g., 10Gi, 50Gi)
#   {{NAMESPACE}}         - Monitoring namespace (e.g., monitoring)

# --- Loki Server Configuration ---
loki:
  enabled: true

  config:
    auth_enabled: false

    server:
      http_listen_port: 3100
      grpc_listen_port: 9096
      log_level: warn

    common:
      path_prefix: /loki
      replication_factor: 1
      storage:
        filesystem:
          chunks_directory: /loki/chunks
          rules_directory: /loki/rules

    schema_config:
      configs:
        - from: "2024-01-01"
          store: tsdb
          object_store: filesystem
          schema: v13
          index:
            prefix: index_
            period: 24h

    storage_config:
      filesystem:
        directory: /loki/chunks

    limits_config:
      # Ingestion limits
      ingestion_rate_mb: 10
      ingestion_burst_size_mb: 20
      per_stream_rate_limit: 5MB
      per_stream_rate_limit_burst: 15MB

      # Retention
      retention_period: {{RETENTION_PERIOD}}

      # Query limits
      max_query_series: 500
      max_query_parallelism: 2
      max_entries_limit_per_query: 5000

    compactor:
      working_directory: /loki/compactor
      compaction_interval: 10m
      retention_enabled: true
      retention_delete_delay: 2h
      delete_request_store: filesystem

    # Ruler for alerting on logs
    ruler:
      storage:
        type: local
        local:
          directory: /loki/rules
      rule_path: /loki/rules-temp
      alertmanager_url: http://monitoring-kube-prometheus-alertmanager:9093
      ring:
        kvstore:
          store: inmemory
      enable_api: true

  persistence:
    enabled: true
    size: {{STORAGE_SIZE}}
    storageClassName: do-block-storage  # DigitalOcean; change for other providers

# --- Promtail Configuration (Log Shipper) ---
promtail:
  enabled: true

  config:
    server:
      http_listen_port: 3101

    clients:
      - url: http://loki:3100/loki/api/v1/push

    positions:
      filename: /run/promtail/positions.yaml

    scrape_configs:
      # Scrape all Kubernetes pod logs
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          # Keep only pods with logs
          - source_labels: [__meta_kubernetes_pod_annotation_promtail_io_scrape]
            action: drop
            regex: "false"

          # Set namespace label
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace

          # Set pod name label
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod

          # Set container name label
          - source_labels: [__meta_kubernetes_pod_container_name]
            target_label: container

          # Set app label from pod label
          - source_labels: [__meta_kubernetes_pod_label_app]
            target_label: app

          # Set component label
          - source_labels: [__meta_kubernetes_pod_label_component]
            target_label: component

        pipeline_stages:
          # Try to parse JSON logs
          - json:
              expressions:
                level: level
                message: message
                timestamp: timestamp
                request_id: request_id
                user_id: user_id
                path: path
                status: status
                duration_ms: duration_ms

          # Set log level from parsed JSON
          - labels:
              level:
              request_id:

          # Set timestamp from log entry
          - timestamp:
              source: timestamp
              format: RFC3339Nano
              fallback_formats:
                - "2006-01-02T15:04:05Z07:00"
                - "2006-01-02 15:04:05"

          # Drop debug logs in production to save storage
          - match:
              selector: '{namespace="production"}'
              stages:
                - drop:
                    source: level
                    value: "debug"

# --- Loki Alerting Rules ---
# Place in /loki/rules/{{NAMESPACE}}/rules.yaml
#
# Example alert: High error rate in logs
# groups:
#   - name: log-alerts
#     rules:
#       - alert: HighErrorRate
#         expr: |
#           sum(rate({namespace="production"} | json | level="error" [5m])) > 0.5
#         for: 5m
#         labels:
#           severity: warning
#         annotations:
#           summary: "High error rate in logs (> 0.5 errors/sec)"
