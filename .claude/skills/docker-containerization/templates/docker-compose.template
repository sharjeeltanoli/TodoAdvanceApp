# =============================================================================
# Docker Compose - Full Stack Template
# =============================================================================
# Usage: Replace {{PLACEHOLDERS}} with project values
#   {{PROJECT_NAME}}     - Project/stack name
#   {{FRONTEND_PORT}}    - Frontend port (default: 3000)
#   {{BACKEND_PORT}}     - Backend port (default: 8000)
#   {{DB_PORT}}          - Database port (default: 5432)
#   {{DB_NAME}}          - Database name
#   {{DB_USER}}          - Database user
#   {{POSTGRES_VERSION}} - PostgreSQL version (default: 17)
# =============================================================================

name: {{PROJECT_NAME}}

services:
  # -------------------------------------------------------------------------
  # Frontend (Next.js)
  # -------------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=http://backend:{{BACKEND_PORT}}
    ports:
      - "{{FRONTEND_PORT}}:{{FRONTEND_PORT}}"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://backend:{{BACKEND_PORT}}
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - frontend
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

  # -------------------------------------------------------------------------
  # Backend (FastAPI)
  # -------------------------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "{{BACKEND_PORT}}:{{BACKEND_PORT}}"
    environment:
      - DATABASE_URL=postgresql+asyncpg://{{DB_USER}}:${DB_PASSWORD}@db:{{DB_PORT}}/{{DB_NAME}}
      - PORT={{BACKEND_PORT}}
      - ENVIRONMENT=production
    env_file:
      - .env
    depends_on:
      db:
        condition: service_healthy
    networks:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

  # -------------------------------------------------------------------------
  # Database (PostgreSQL)
  # -------------------------------------------------------------------------
  db:
    image: postgres:{{POSTGRES_VERSION}}-alpine
    ports:
      - "{{DB_PORT}}:5432"
    environment:
      - POSTGRES_DB={{DB_NAME}}
      - POSTGRES_USER={{DB_USER}}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{DB_USER}} -d {{DB_NAME}}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"

volumes:
  postgres_data:
    driver: local

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
