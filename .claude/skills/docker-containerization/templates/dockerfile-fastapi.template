# =============================================================================
# FastAPI Multi-Stage Production Dockerfile
# =============================================================================
# Usage: Replace {{PLACEHOLDERS}} with project values
#   {{PYTHON_VERSION}}  - Python version (e.g., 3.13, 3.12, 3.11)
#   {{APP_MODULE}}      - ASGI module path (e.g., app.main:app)
#   {{PORT}}            - Application port (default: 8000)
#   {{INSTALLER}}       - uv | pip (default: uv)
# =============================================================================

# ---------------------------------------------------------------------------
# Stage 1: Build dependencies
# ---------------------------------------------------------------------------
FROM python:{{PYTHON_VERSION}}-slim AS builder

WORKDIR /app

# Install system build dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends gcc libpq-dev && \
    rm -rf /var/lib/apt/lists/*

# -- uv installer (recommended, much faster) --
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv
ENV UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=copy

COPY pyproject.toml uv.lock* ./
RUN uv sync --frozen --no-dev --no-install-project

COPY . .
RUN uv sync --frozen --no-dev

# -- pip installer (uncomment and remove uv section) --
# COPY requirements.txt ./
# RUN python -m venv /app/.venv && \
#     /app/.venv/bin/pip install --no-cache-dir -r requirements.txt
# COPY . .

# ---------------------------------------------------------------------------
# Stage 2: Production runner
# ---------------------------------------------------------------------------
FROM python:{{PYTHON_VERSION}}-slim AS runner

WORKDIR /app

# Install runtime-only system dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends libpq5 wget && \
    rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd --system --gid 1001 appgroup && \
    useradd --system --uid 1001 --gid appgroup --create-home appuser

# Copy virtual environment and application from builder
COPY --from=builder --chown=appuser:appgroup /app /app

# Add venv to PATH
ENV PATH="/app/.venv/bin:$PATH" \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PORT={{PORT}}

USER appuser

EXPOSE {{PORT}}

HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:{{PORT}}/health || exit 1

CMD ["uvicorn", "{{APP_MODULE}}", "--host", "0.0.0.0", "--port", "{{PORT}}", "--workers", "2"]
