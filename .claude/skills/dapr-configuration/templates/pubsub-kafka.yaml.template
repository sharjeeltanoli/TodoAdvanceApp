# Dapr Pub/Sub Component â€” Apache Kafka (Production)
# Docs: https://docs.dapr.io/reference/components-reference/supported-pubsub/setup-apache-kafka/
#
# Usage: Replace {{PLACEHOLDERS}} with actual values.
# Apply: kubectl apply -f pubsub-kafka.yaml -n {{NAMESPACE}}

apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: {{PUBSUB_NAME|default:pubsub}}
  namespace: {{NAMESPACE|default:default}}
spec:
  type: pubsub.kafka
  version: v1
  metadata:
    # --- Broker Configuration ---
    - name: brokers
      value: "{{KAFKA_BROKERS|example:kafka-0.kafka.svc.cluster.local:9092}}"
    - name: consumerGroup
      value: "{{CONSUMER_GROUP|default:todo-app-group}}"

    # --- Authentication (SASL/PLAIN for managed Kafka) ---
    - name: authType
      value: "{{AUTH_TYPE|default:none}}"  # none | password | mtls | oidc
    # Uncomment for SASL/PLAIN (e.g., Confluent Cloud, MSK):
    # - name: saslUsername
    #   secretKeyRef:
    #     name: kafka-credentials
    #     key: username
    # - name: saslPassword
    #   secretKeyRef:
    #     name: kafka-credentials
    #     key: password
    # - name: saslMechanism
    #   value: "PLAIN"

    # --- TLS ---
    # - name: tls
    #   value: "true"
    # - name: tlsSkipVerify
    #   value: "false"

    # --- Topic Configuration ---
    - name: maxMessageBytes
      value: "1048576"  # 1 MB
    - name: consumeRetryInterval
      value: "200ms"
    - name: version
      value: "{{KAFKA_VERSION|default:2.0.0}}"
    - name: initialOffset
      value: "{{INITIAL_OFFSET|default:newest}}"  # newest | oldest
    - name: disableTls
      value: "{{DISABLE_TLS|default:true}}"  # Set false in production

    # --- Retry & Delivery ---
    - name: maxRetry
      value: "3"
    - name: backOffDuration
      value: "2s"

  # Scope to specific app-ids
  scopes:
    - {{APP_ID_1|default:backend-api}}
    - {{APP_ID_2|default:mcp-server}}

# Optional: secret store reference for credentials
# auth:
#   secretStore: kubernetes
