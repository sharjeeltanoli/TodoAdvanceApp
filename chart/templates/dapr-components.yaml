{{- if .Values.dapr.enabled }}
# Pub/Sub Component (Redpanda/Kafka)
# Supports two auth modes via dapr.pubsub.authType:
#   - "none"  → local dev (in-cluster Redpanda, no auth)
#   - "scram" → cloud (Redpanda Cloud, SASL/SCRAM-SHA-256 via K8s secret)
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: pubsub
spec:
  type: pubsub.kafka
  version: v1
  ignoreErrors: true   # Don't crash sidecar if Redpanda is unreachable/misconfigured
  metadata:
    {{- if eq .Values.dapr.pubsub.authType "scram" }}
    - name: brokers
      secretKeyRef:
        name: app-secrets
        key: REDPANDA_BROKERS
    - name: authType
      value: "scramsha256"   # Dapr 1.14+: "scramsha256" (not "scram")
    - name: saslUsername
      secretKeyRef:
        name: app-secrets
        key: REDPANDA_USERNAME
    - name: saslPassword
      secretKeyRef:
        name: app-secrets
        key: REDPANDA_PASSWORD
    - name: disableTls
      value: "false"
    {{- else }}
    - name: brokers
      value: {{ .Values.dapr.pubsub.brokers | quote }}
    - name: consumerGroup
      value: "{appID}-group"
    - name: authType
      value: "none"
    - name: disableTls
      value: {{ .Values.dapr.pubsub.disableTls | quote }}
    {{- end }}
    - name: maxMessageBytes
      value: "1048576"
    - name: consumeRetryInterval
      value: "200ms"
    - name: version
      value: "2.0.0"
    - name: allowedTopics
      value: "task-events,reminders,task-updates"
  auth:
    secretStore: kubernetes
  scopes:
    - backend-api
    - notification-svc
    - sse-gateway
    - mcp-server
---
# State Store Component (Redis)
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: statestore
spec:
  type: state.redis
  version: v1
  metadata:
    - name: redisHost
      value: {{ .Values.dapr.statestore.redisHost | quote }}
    - name: redisPassword
      value: ""
    - name: actorStateStore
      value: "false"
    - name: keyPrefix
      value: "name"
  scopes:
    - backend-api
    - notification-svc
    - mcp-server
---
# Cron Binding for Overdue Checks
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: cron-overdue-check
spec:
  type: bindings.cron
  version: v1
  metadata:
    - name: schedule
      value: {{ .Values.dapr.cronSchedule | quote }}
    - name: route
      value: "/cron-overdue-check"
  scopes:
    - backend-api
---
# Dapr Configuration
# Note: mtls is cluster-wide (set via Dapr control plane install), NOT per-app config.
# Only tracing, metrics, and logging are valid here.
apiVersion: dapr.io/v1alpha1
kind: Configuration
metadata:
  name: dapr-config
spec:
  tracing:
    samplingRate: {{ .Values.dapr.tracing.samplingRate | quote }}
    {{- if .Values.dapr.tracing.zipkin.enabled }}
    zipkin:
      endpointAddress: {{ .Values.dapr.tracing.endpointAddress | default "" | quote }}
    {{- end }}
  metric:
    enabled: {{ .Values.dapr.metrics.enabled }}
  logging:
    apiLogging:
      enabled: true
---
# Resiliency Policy
apiVersion: dapr.io/v1alpha1
kind: Resiliency
metadata:
  name: todo-app-resiliency
spec:
  policies:
    retries:
      pubsubRetry:
        policy: exponential
        maxInterval: 30s
        maxRetries: 5
      serviceRetry:
        policy: constant
        duration: 3s
        maxRetries: 3
    circuitBreakers:
      simpleCB:
        maxRequests: 1
        interval: 10s
        timeout: 30s
        trip: consecutiveFailures >= 3
  targets:
    apps:
      notification-svc:
        retry: serviceRetry
        circuitBreaker: simpleCB
      mcp-server:
        retry: serviceRetry
        circuitBreaker: simpleCB
    components:
      pubsub:
        outbound:
          retry: pubsubRetry
        inbound:
          retry: pubsubRetry
      statestore:
        outbound:
          retry: serviceRetry
{{- end }}
