name: Deploy to Staging

on:
  workflow_run:
    workflows: ["Build and Push Images"]
    branches: [main]
    types: [completed]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: staging

    steps:
      - uses: actions/checkout@v4

      - name: Set image tag from commit SHA
        id: tag
        run: |
          SHORT_SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
          echo "IMAGE_TAG=sha-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Save kubeconfig
        run: doctl kubernetes cluster kubeconfig save k8s-1-34-1-do-3-nyc1-1771651785370

      - name: Install Helm
        uses: azure/setup-helm@fe7b79cd5ee1e45176fcad797de68ecaf3ca4814 # v4.2.0
        with:
          version: v3.16.3

      - name: Clean up stuck Helm release if any
        run: |
          STATUS=$(helm status todo-app-staging -n staging -o json 2>/dev/null | jq -r '.info.status' 2>/dev/null || echo "not-found")
          echo "Current Helm status: $STATUS"
          if [[ "$STATUS" == "pending-install" || "$STATUS" == "pending-upgrade" || "$STATUS" == "pending-rollback" || "$STATUS" == "failed" ]]; then
            echo "Stuck/failed Helm release detected ($STATUS) — forcing uninstall"
            helm uninstall todo-app-staging -n staging --no-hooks 2>/dev/null || true
            sleep 5
          fi

      - name: Helm upgrade staging
        run: |
          helm upgrade --install todo-app-staging ./chart \
            -f ./chart/values-staging.yaml \
            --namespace staging \
            --create-namespace \
            --set global.imageTag=${{ steps.tag.outputs.IMAGE_TAG }} \
            --atomic \
            --timeout 8m \
            --history-max 10

      - name: Verify staging deployment
        run: |
          kubectl rollout status deployment/todo-app-staging-backend -n staging --timeout=5m
          kubectl rollout status deployment/todo-app-staging-frontend -n staging --timeout=5m
          kubectl rollout status deployment/todo-app-staging-sse-gateway -n staging --timeout=3m
          echo "Staging deploy complete — image: ${{ steps.tag.outputs.IMAGE_TAG }}"
