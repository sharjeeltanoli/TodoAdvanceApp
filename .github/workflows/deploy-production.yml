name: Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (default: main-latest)"
        required: false
        default: "main-latest"

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production   # Requires manual approval in GitHub → Settings → Environments

    steps:
      - uses: actions/checkout@v4

      - name: Set image tag
        id: tag
        run: |
          # build.yml only tags images on branch pushes (sha-* and main-latest).
          # Semver tags (v*) are never built, so use main-latest which is always
          # the image from the most recent push to main.
          # workflow_dispatch can override via image_tag input.
          IMAGE_TAG="${{ github.event.inputs.image_tag || 'main-latest' }}"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> "$GITHUB_OUTPUT"
          echo "RELEASE_VERSION=${{ github.event.release.tag_name || 'manual' }}" >> "$GITHUB_OUTPUT"

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Save kubeconfig
        run: doctl kubernetes cluster kubeconfig save k8s-1-34-1-do-3-nyc1-1771651785370

      - name: Create ghcr-pull-secret in production namespace
        run: |
          kubectl create namespace production --dry-run=client -o yaml | kubectl apply -f -
          kubectl create secret docker-registry ghcr-pull-secret \
            --namespace production \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Install Helm
        uses: azure/setup-helm@fe7b79cd5ee1e45176fcad797de68ecaf3ca4814 # v4.2.0
        with:
          version: v3.16.3

      - name: Clean up stuck Helm release if any
        run: |
          STATUS=$(helm status todo-app -n production -o json 2>/dev/null | jq -r '.info.status' 2>/dev/null || echo "not-found")
          echo "Current Helm status: $STATUS"
          if [[ "$STATUS" == "pending-install" || "$STATUS" == "pending-upgrade" || "$STATUS" == "pending-rollback" || "$STATUS" == "failed" ]]; then
            echo "Stuck/failed Helm release detected ($STATUS) — forcing uninstall"
            helm uninstall todo-app -n production --no-hooks 2>/dev/null || true
            sleep 5
          fi

      - name: Helm upgrade production
        run: |
          helm upgrade --install todo-app ./chart \
            -f ./chart/values-production.yaml \
            --namespace production \
            --create-namespace \
            --set global.imageTag=${{ steps.tag.outputs.IMAGE_TAG }} \
            --atomic \
            --timeout 20m \
            --history-max 10

      - name: Debug pod status on failure
        if: failure()
        run: |
          echo "=== Pods ==="
          kubectl get pods -n production -o wide
          echo "=== Events (last 40) ==="
          kubectl get events -n production --sort-by=.lastTimestamp | tail -40
          echo "=== Describe failing pods ==="
          kubectl get pods -n production --no-headers | awk '$3 != "Running" && $3 != "Completed" {print $1}' | \
            xargs -I{} kubectl describe pod {} -n production 2>/dev/null | head -100

      - name: Verify production deployment
        run: |
          kubectl rollout status deployment/todo-app-backend -n production --timeout=8m
          kubectl rollout status deployment/todo-app-frontend -n production --timeout=8m
          kubectl rollout status deployment/todo-app-sse-gateway -n production --timeout=5m

      - name: Production smoke test
        run: |
          sleep 15  # allow LB to route traffic
          curl -fk --max-time 30 "https://todo.165-245-153-207.nip.io/api/auth/get-session" || \
            (echo "Smoke test failed — check https://todo.165-245-153-207.nip.io" && exit 1)
          echo "Production deploy complete — release: ${{ steps.tag.outputs.RELEASE_VERSION }}, image: ${{ steps.tag.outputs.IMAGE_TAG }}"
