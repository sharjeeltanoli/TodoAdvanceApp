name: Deploy to Production

on:
  release:
    types: [published]

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production   # Requires manual approval in GitHub → Settings → Environments

    steps:
      - uses: actions/checkout@v4

      - name: Set image tag from release
        id: tag
        run: echo "IMAGE_TAG=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Save kubeconfig
        run: doctl kubernetes cluster kubeconfig save k8s-1-34-1-do-3-nyc1-1771651785370

      - name: Install Helm
        uses: azure/setup-helm@fe7b79cd5ee1e45176fcad797de68ecaf3ca4814 # v4.2.0
        with:
          version: v3.16.3

      - name: Helm upgrade production
        run: |
          helm upgrade --install todo-app ./chart \
            -f ./chart/values-production.yaml \
            --namespace production \
            --create-namespace \
            --set global.imageTag=${{ steps.tag.outputs.IMAGE_TAG }} \
            --atomic \
            --timeout 10m \
            --history-max 10

      - name: Verify production deployment
        run: |
          kubectl rollout status deployment/todo-app-backend -n production --timeout=8m
          kubectl rollout status deployment/todo-app-frontend -n production --timeout=8m
          kubectl rollout status deployment/todo-app-sse-gateway -n production --timeout=5m

      - name: Production smoke test
        run: |
          sleep 15  # allow LB to route traffic
          curl -f --max-time 30 "https://todo.${{ vars.DOMAIN }}/api/health" || \
            (echo "Smoke test failed — check https://todo.${{ vars.DOMAIN }}/api/health" && exit 1)
          echo "Production deploy complete — version: ${{ steps.tag.outputs.IMAGE_TAG }}"
